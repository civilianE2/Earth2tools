<!DOCTYPE html>
<html>
<head>
    <title>E2V1 Daytime Visualizer by Civilian Earth2.fi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; background: #00050a; cursor: crosshair; }
        body { margin: 0; background: #111; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .info { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; border: 1px solid #00d4ff; pointer-events: none; }
        .leaflet-popup-content-wrapper { background: transparent; box-shadow: none; padding: 0; }
        .leaflet-popup-tip { background: #1a1a1a; }
    </style>
</head>
<body>
    <div class="info">
        <b style="color: #00d4ff;">E2V1 Daylight Map by Civilian</b><br>
        â€¢ Earth2.fi<br>
        â€¢ Klikkaa nÃ¤hdÃ¤ksesi E2V1-ajan ja auringon
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const corner1 = L.latLng(-85, -180);
        const corner2 = L.latLng(85, 180);
        const bounds = L.latLngBounds(corner1, corner2);

        const map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0,
            minZoom: 2,
            worldCopyJump: false
        }).setView([60, 24], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            noWrap: true,
            bounds: bounds
        }).addTo(map);

        const shadowGroup = L.layerGroup().addTo(map);

        function getSolarDeclination() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const dayOfYear = Math.floor((now - start) / 86400000);
            return (23.45 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81))) * Math.PI / 180;
        }

        function calculateSunTimes(lat, lon) {
            const latRad = lat * Math.PI / 180;
            const decl = getSolarDeclination();
            const cosH = (Math.sin(-0.833 * Math.PI / 180) - Math.sin(latRad) * Math.sin(decl)) / (Math.cos(latRad) * Math.cos(decl));
            if (cosH > 1) return { rise: "Kaamos", set: "Kaamos" };
            if (cosH < -1) return { rise: "YÃ¶tÃ¶n yÃ¶", set: "YÃ¶tÃ¶n yÃ¶" };
            const H = Math.acos(cosH) * (180 / Math.PI) / 15;
            const solarNoon = 12 - (lon / 15);
            const format = (h) => {
                const totalM = (h * 60 + 1440) % 1440;
                return `${Math.floor(totalM/60).toString().padStart(2,'0')}:${Math.floor(totalM%60).toString().padStart(2,'0')}`;
            };
            return { rise: format(solarNoon - H), set: format(solarNoon + H) };
        }

        function updateShadows() {
            shadowGroup.clearLayers();
            const decl = getSolarDeclination();
            const now = new Date();
            
            const drawLayer = (limit, color, opacity) => {
                for (let lon = -180; lon < 180; lon += 1.5) {
                    let points = [];
                    for (let lat = 85; lat >= -85; lat -= 3) {
                        const latRad = lat * Math.PI / 180;
                        const utcSecs = (now.getUTCHours() * 3600) + (now.getUTCMinutes() * 60) + now.getUTCSeconds();
                        // TÃ„RKEÃ„ KORJAUS: LisÃ¤tty Math.PI
                        const hourAngle = (((((utcSecs + (lon/15)*3600)*4)%86400)/86400)*360-180)*Math.PI/180;
                        const alt = Math.asin(Math.sin(latRad)*Math.sin(decl) + Math.cos(latRad)*Math.cos(decl)*Math.cos(hourAngle)) * (180/Math.PI);
                        if (alt < limit) points.push([lat, lon]);
                    }
                    if (points.length > 0) {
                        L.polygon(points.concat(points.map(p => [p[0], p[1] + 1.5]).reverse()), {
                            fillColor: color, fillOpacity: opacity, stroke: false, interactive: false
                        }).addTo(shadowGroup);
                    }
                }
            }
            drawLayer(0, '#000', 0.25);
            drawLayer(-12, '#000', 0.45);
        }

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            const sun = calculateSunTimes(lat, lng);
            const now = new Date();
            const zoneOffset = -(now.getTimezoneOffset() / 60);
            const utcSecs = (now.getUTCHours() * 3600) + (now.getUTCMinutes() * 60) + now.getUTCSeconds();
            
            const e2v1Total = ((utcSecs + (zoneOffset * 3600)) * 4) % 86400;
            const e2h = Math.floor(e2v1Total / 3600).toString().padStart(2,'0');
            const e2m = Math.floor((e2v1Total % 3600) / 60).toString().padStart(2,'0');

            L.popup({ minWidth: 260 })
                .setLatLng(e.latlng)
                .setContent(`
                    <div style="background: #1a1a1a; color: white; padding: 15px; font-family: sans-serif; border-radius: 8px; border: 1px solid #333;">
                        <h2 style="margin: 0 0 5px 0; color: #00d4ff; font-size: 18px; text-transform: uppercase;">Sijaintitiedot</h2>
                        <div style="border-bottom: 1px solid #333; margin-bottom: 15px;"></div>
                        <div style="margin-bottom: 15px;">
                            <span style="font-size: 11px; color: #888; text-transform: uppercase;">Koordinaatit:</span><br>
                            <span style="font-size: 15px;">${lat.toFixed(4)}Â°, ${lng.toFixed(4)}Â°</span>
                        </div>
                        <div style="background: #252525; padding: 15px; border-radius: 6px; border-left: 4px solid #ffcc00; margin-bottom: 20px;">
                            <span style="font-size: 11px; color: #aaa; text-transform: uppercase; font-weight: bold;">E2V1 Kellonaika:</span><br>
                            <span style="font-size: 36px; font-weight: bold; color: #ffcc00; line-height: 1.2;">${e2h}:${e2m}</span>
                        </div>
                        <div style="font-size: 14px; margin-bottom: 10px; display: flex; align-items: center;">
                            <span style="font-size: 20px; margin-right: 12px;">ðŸŒ…</span> <b>Nousu:</b> <span style="margin-left: auto;">${sun.rise}</span>
                        </div>
                        <div style="font-size: 14px; display: flex; align-items: center;">
                            <span style="font-size: 20px; margin-right: 12px;">ðŸŒ‡</span> <b>Lasku:</b> <span style="margin-left: auto;">${sun.set}</span>
                        </div>
                        <div style="border-top: 1px solid #333; padding-top: 8px; margin-top: 15px; font-size: 11px; color: #555; text-align: right;">
                            E2V1 Global Seasonal Engine
                        </div>
                    </div>
                `)
                .openOn(map);
        });

        setInterval(updateShadows, 10000);
        updateShadows();
    </script>
</body>
</html>
